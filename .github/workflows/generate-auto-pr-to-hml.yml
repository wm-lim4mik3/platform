name: Generate Changelog and PR

on:
  push:
    branches:
      - 'feat/PF-*'
      - 'fix/PF-*'

jobs:
  prepare-to-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Fetch HML and Generate Changelog
        id: changelog
        run: |
          echo "ğŸ”„ Iniciando processo de geraÃ§Ã£o de changelog..."

          git fetch origin hml

          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          CURRENT_HEAD=$(git rev-parse HEAD)
          HML_COMMIT=$(git rev-parse origin/hml)
          COMMITS_AHEAD=$(git rev-list --count origin/hml..HEAD)
          AUTHORS=$(git log origin/hml..HEAD --pretty=format:'%an' | sort | uniq | paste -sd, -)

          echo "ğŸ“ Branch atual: $CURRENT_BRANCH"
          echo "ğŸ”¨ HEAD ($CURRENT_BRANCH): $CURRENT_HEAD"
          echo "ğŸ¯ Target (origin/hml): $HML_COMMIT"

          commits=$(git log origin/hml..HEAD --pretty=format:"%h|%s|%ad" --date=short)

          if [ -z "$commits" ]; then
            echo "âœ… Nenhum commit novo encontrado em relaÃ§Ã£o Ã  HML. PR nÃ£o serÃ¡ criado."
            echo "skip_pr=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          changelog_body="## ğŸ“¦ AtualizaÃ§Ãµes desta entrega automÃ¡tica

          Este PR foi gerado automaticamente apÃ³s push na branch feature/correÃ§Ã£o. Por favor, revise com atenÃ§Ã£o. ğŸ§

          ### ğŸ“Œ InformaÃ§Ãµes do PR
          - ğŸ‘¤ **Autores do push:** $AUTHORS
          - ğŸŒ¿ **Branch source:** \`$CURRENT_BRANCH\`
          - ğŸ¯ **Branch target:** \`hml\`
          - ğŸ“¦ **Commits Ã  frente de 'hml':** $COMMITS_AHEAD
          - ğŸ§  **HEAD atual:** \`$CURRENT_HEAD\`
          - ğŸ§± **Ãšltimo commit em 'hml':** \`$HML_COMMIT\`

          ### ğŸ†• HistÃ³rico de atualizaÃ§Ãµes"

          while IFS= read -r line; do
            IFS='|' read -r hash subject date <<< "$line"
            changelog_body+=$'\n- **UPDATE '"$date"'** - `'"$hash"'` - '"$subject"
          done <<< "$commits"

          echo "skip_pr=false" >> "$GITHUB_OUTPUT"
          echo "changelog<<EOF" >> "$GITHUB_OUTPUT"
          echo "$changelog_body" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Instalar GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh

      - name: Criar ou Atualizar Pull Request com GitHub CLI
        if: steps.changelog.outputs.skip_pr == 'false'
        run: |
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          PR_TITLE="[$(echo "$CURRENT_BRANCH" | grep -o 'PF-[0-9]\+')]- ğŸ¤– PR AutomÃ¡tico"

          echo "ğŸ” Verificando se jÃ¡ existe PR da branch '$CURRENT_BRANCH' para 'hml'..."
          EXISTING_PR_URL=$(gh pr list --base hml --head "$CURRENT_BRANCH" --json url --jq '.[0].url')

          if [ -n "$EXISTING_PR_URL" ]; then
            echo "âœï¸ PR encontrado, atualizando body..."
            gh pr edit "$EXISTING_PR_URL" --body "${{ steps.changelog.outputs.changelog }}"
          else
            echo "ğŸš€ PR nÃ£o encontrado, criando novo..."
            gh pr create \
              --title "$PR_TITLE" \
              --body "${{ steps.changelog.outputs.changelog }}" \
              --head "$CURRENT_BRANCH" \
              --base hml \
              # --label "auto-pr" \
              # --reviewer "wm-lim4mik3"
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT }}
